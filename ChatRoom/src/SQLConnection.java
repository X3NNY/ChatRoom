import java.sql.*;import java.util.*;public class SQLConnection {    static final String url = "jdbc:mysql://localhost:3306/CRS?useUnicode=true&characterEncoding=utf-8&useSSL=false";    static final String username = "root";    static final String password = "root";    static Connection conn;    static {        try {            Class.forName("com.mysql.jdbc.Driver");            Connection conn = (Connection) DriverManager.getConnection(url, username, password);            SQLConnection.conn = conn;        } catch (Exception e) {            e.printStackTrace();        }    }    public static Statement creat() throws SQLException {        Statement stat = conn.createStatement();        return stat;    }    public static boolean insert(User user) throws SQLException {        String sql = "insert into user(username,`password`) values('" + user.getUsername() + "','" + user.getPassword() + "');";        Statement s = creat();        boolean flag = s.execute(sql);        s.close();        return flag;    }    public static boolean isFollow(int uid, int fid) throws SQLException {        String sql = "select id from friendtemp where uid=" + uid + " and fid=" + fid + ";";        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        boolean flag = false;        while (rs.next()){            flag = true;        }        s.close();        rs.close();        return flag;    }    public static void addUser(int uid,int fid) throws SQLException {        if (isFollow(uid, fid)) {            return ;//成功关注        }        String sql = "insert into friendtemp(uid,fid) values(" + uid + "," + fid + ")";        String sql2 = "insert into friendtemp(uid,fid) values(" + fid + "," + uid + ")";        Statement s = creat(), s2 = creat();        s.execute(sql);        s.execute(sql2);        s.close();        s2.close();    }    public static boolean unPullBlack(String username, String friendname) throws SQLException {        int uid = usernameGetId(username), fid = usernameGetId(friendname);        String sql = "update friendtemp set flag=0 where uid=" + uid + " and flag=1 and fid=" + fid + ";";        Statement s = creat();        s.executeUpdate(sql);        s.close();        return true;    }    /**     * public static User select(String username) throws SQLException {     * String sql = "select u from user where username"     * }     */    public static boolean isPullBlack(int uid, int fid) throws SQLException {        String sql = "select flag from friendtemp where uid=" + uid + " and fid=" + fid + ";";        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        boolean flag = false;        if (rs.next()) flag =  rs.getInt("flag") != 0;        rs.close();        s.close();        return flag;    }    public static boolean pullBlack(String username, String friendname) throws SQLException {        int uid = usernameGetId(username), fid = usernameGetId(friendname);        if (isPullBlack(uid,fid)) {            return true;        }        String sql = "update friendtemp set flag=1 where uid=" + uid + " and fid=" + fid + ";";        Statement s = creat();        s.executeUpdate(sql);        s.close();        return true;    }    public static boolean isInGroup(int uid, int gid) throws SQLException {        String sql = "select id from grouptemp where uid=" + uid + " and gid=" + gid + ";";        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        boolean flag = false;        if (rs.next()) {            flag = true;        }        rs.close();        s.close();        return flag;    }    public static boolean checkPassword(String password, int gid) throws SQLException {        String sql = "select * from `group` where id=" + gid + ";";        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        boolean flag = false;        while (rs.next()) {            flag = rs.getString("password").equals(password);        }        rs.close();        s.close();        return flag;    }    public static boolean addGroup(int uid, int gid) throws SQLException {        if (isInGroup(uid, gid)) {            return true;        }        String sql = "insert into grouptemp(uid,gid) values(" + uid + "," + gid + ");";        Statement s = creat();        boolean flag = s.execute(sql);        s.close();        return flag;    }    public static boolean insert(Group group) throws SQLException {        if (isExistGroup(group)) {            return false;        }        String sql = "insert into `group`(groupname,`desc`,`password`,uid) values('" + group.getGroupname() + "','" + group.getDesc() + "','" + group.getPassword() + "'," + group.getUid() + ");";        Statement s = creat();        boolean flag = s.execute(sql);        s.close();        return flag;    }    public static boolean isExistGroup(Group group) throws SQLException {        String sql = "select * from `group` where groupname='" + group.getGroupname() + "';";        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        boolean flag = false;        if (rs.next()) {            flag = true;        }        rs.close();        s.close();        return flag;    }    public static void deleteUser(int gid, int uid) throws SQLException {        String sql = "delete from grouptemp where gid=" + gid + " and uid=" + uid;        Statement s = creat();        s.execute(sql);        s.close();    }    public static int groupnameGetId(String groupname) throws SQLException {        String sql = "select * from `group` where groupname='" + groupname + "';";        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        int flag = -1;        while (rs.next()) {            flag = rs.getInt("id");        }        rs.close();        s.close();        return flag;    }    public static int usernameGetId(String username) throws SQLException {        String sql = "select * from user where username='" + username + "';";        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        int flag = -1;        while (rs.next()) {            flag = rs.getInt("id");        }        rs.close();        s.close();        return flag;    }    public static boolean checkPassword(User user) throws SQLException {        String sql = "select * from user where username='" + user.getUsername() + "';";        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        boolean flag = false;        while (rs.next()) {            flag = rs.getString("password").equals(user.getPassword());        }        rs.close();        s.close();        return flag;    }    public static boolean isExistUser(User user) throws SQLException {        String sql = "select * from user where username='" + user.getUsername() + "';";        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        boolean flag = false;        while (rs.next()) {            flag = true;        }        rs.close();        s.close();        return flag;    }    public static void insertMsg(String username1, String username2, String msg, boolean flag) throws SQLException{        int uid = usernameGetId(username1), fid = usernameGetId(username2);        String sql = "insert into message(uid,fid,msg,flag) values(" + uid + "," + fid + ",'" + msg + "'," + (flag?1:0) + ");";        Statement s = creat();        s.execute(sql);        s.close();    }    public static void insertMsg(String username, String groupname, boolean flag,String msg,String fname) throws SQLException {        int uid = usernameGetId(username), gid = groupnameGetId(groupname), fid = usernameGetId(fname);        String sql = "insert into groupmessage(uid,fid,gid,msg,flag) values(" + uid + "," + fid + "," + gid + ",'" + msg + "'," + (flag?1:0) + ");";        Statement s = creat();        s.execute(sql);        s.close();    }    public static String useridGetName(int id) throws SQLException {        String sql = "select username from user where id=" + id;        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        String tmp = "";        while (rs.next()) {            tmp = rs.getString("username");        }        rs.close();        s.close();        return tmp;    }    public static String groupidGetName(int id) throws SQLException {        String sql = "select groupname from `group` where id=" + id;        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        String tmp = "";        while (rs.next()) {            tmp = rs.getString("groupname");        }        rs.close();        s.close();        return tmp;    }    public static void updateGroup() {        try {            String sql = "select * from grouptemp";            Statement s = creat();            ResultSet rs = s.executeQuery(sql);            while (rs.next()) {                String groupname = groupidGetName(rs.getInt("gid")), username = useridGetName(rs.getInt("uid"));                if (!ChatTools.svMap.containsKey(groupname)) {                    ChatTools.svMap.put(groupname,new Vector<>());                }                ChatTools.svMap.get(groupname).add(username);            }        } catch (SQLException e) {            e.printStackTrace();        }    }    public static void updateGroup(Group group) throws SQLException{        String sql = "insert into grouptemp(uid,gid) values(" + group.getUid() + "," + group.getId() + ");";        Statement s = creat();        s.execute(sql);        s.close();    }    public static boolean isGroupAdmin(int gid, int uid) throws SQLException {        String sql = "select uid from `group` where id=" + gid + ";";        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        boolean flag = false;        if (rs.next() && rs.getInt("uid") == uid) {            flag = true;        }        rs.close();        s.close();        return flag;    }    public static void dismissGroup(int gid) throws SQLException {        String sql = "delete from `group` where id='" + gid + "';";        String sql2 = "delete from grouptemp where gid=" + gid + ";";        Statement s = creat(), s2 = creat();        s.execute(sql);        s2.execute(sql2);        s.close();        s2.close();    }    public static void exitGroup(int gid, int uid) throws SQLException {        String sql = "delete from grouptemp where gid=" + gid + " and uid=" + uid + ";";        Statement s = creat();        s.execute(sql);        s.close();    }    public static void updateGroupData(String groupname, String desc) throws SQLException {        String sql = "update `group` set `desc`='" + desc + "' where groupname='" + groupname + "';";        Statement s = creat();        s.executeUpdate(sql);        s.close();    }    public static boolean isExistUser(String username) throws SQLException {        String sql = "select id from user where username='" + username + "';";        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        boolean flag = false;        if (rs.next()) {            flag = true;        }        rs.close();        s.close();        return flag;    }    public static int getGroupAdminUser(String groupname) throws SQLException {        String sql = "select uid from `group` where groupname='" + groupname + "';";        Statement s = creat();        ResultSet rs = creat().executeQuery(sql);        int uid = -1;        if (rs.next()) {            uid = rs.getInt("uid");        }        rs.close();        s.close();        return uid;    }    public static void deleteFriend(String username, String friendname) throws SQLException {        int uid = usernameGetId(username), fid = usernameGetId(friendname);        String sql = "delete from friendtemp where uid=" + uid + " and fid=" + fid + ";";        Statement s = creat();        s.execute(sql);        s.close();    }    public static void updatePullBlack() throws SQLException {        String sql = "select uid,fid from friendtemp where flag=1;";        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        while (rs.next()) {            String username = useridGetName(rs.getInt("uid"));            String friendname = useridGetName(rs.getInt("fid"));            ChatTools.addToPullBlack(username,friendname);        }        rs.close();        s.close();    }    public static void insertUserFont(String username, String co, int ft, int fontSize) throws SQLException{        String sql = "update user set `color`='" + co + "',ft=" + ft + ",`size`=" + fontSize + " where username='" + username + "';";        Statement s = creat();        s.executeUpdate(sql);        s.close();    }    public static Object[] getUserFont(String username) throws SQLException{        String sql = "select * from user where username='" + username + "';";        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        Object[] tmp = new Object[3];        if (rs.next()) {            tmp[0] = rs.getInt("ft");            tmp[1] = rs.getInt("size");            tmp[2] = rs.getString("color");        }        rs.close();        s.close();        return tmp;    }    public static void updateUserInfo(String name,int flag) throws SQLException {        String sql = "update user set flag=" + flag + " where username='" + name + "';";        Statement s = creat();        s.executeUpdate(sql);        s.close();    }    public static boolean isUserLogin(String name) throws SQLException{        String sql = "select flag from user where flag=1 and username='" + name + "';";        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        boolean flag = false;        if (rs.next()) {            flag = true;        }        rs.close();        s.close();        return flag;    }    public static void updateUserPassword(User user, String newPass) throws SQLException {        String sql = "update user set `password`='" + MD5.encode(newPass) + "' where username='" + user.getUsername() + "';";        Statement s = creat();        s.executeUpdate(sql);        s.close();    }    public static boolean isOnlineUser(String username) throws SQLException{        String sql = "select flag from user where username='" + username + "';";        Statement s = creat();        ResultSet rs = s.executeQuery(sql);        boolean flag = true;        if (rs.next()) {            flag = (rs.getInt("flag") == 1);        }        rs.close();        s.close();        return flag;    }}